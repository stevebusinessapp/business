{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Multi-Purpose Business App{% endblock %}
{% block page_title %}{{ title }}{% endblock %}
{% block breadcrumb %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* Template color variables */
    :root {
        {% if default_template %}
            --primary-color: {{ default_template.primary_color }};
            --secondary-color: {{ default_template.secondary_color }};
            --text-color: {{ default_template.text_color }};
            --accent-color: {{ default_template.accent_color }};
        {% else %}
            --primary-color: #FF5900;
            --secondary-color: #f8f9fa;
            --text-color: #333333;
            --accent-color: #e9ecef;
        {% endif %}
    }
    
    /* LOADING OPTIMIZATION - Hide content until fully loaded */
    
    /* Loading spinner */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 1;
        transition: opacity 0.3s ease-out;
    }
    
    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #e91e63;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Dynamic Invoice Styles */
    .invoice-creator {
        display: flex;
        gap: 20px;
        height: auto;
        min-height: auto;
        max-height: none;
        overflow: visible;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    
    .invoice-creator.loaded {
        opacity: 1;
    }

    /* FIX FORM FIELD LABEL OVERLAPPING */
    .form-group {
        margin-bottom: 20px;
        position: relative;
    }
    
    .form-group .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #344767;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
        z-index: 1;
    }
    
    .form-group .form-control,
    .form-group .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d2d6da;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.5;
        background-color: #fff;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        position: relative;
        z-index: 0;
    }
    
    .form-group .form-control:focus,
    .form-group .form-select:focus {
        border-color: #e91e63;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(233, 30, 99, 0.25);
    }
    
    .form-group .form-control::placeholder {
        color: #adb5bd;
        opacity: 0.7;
    }
    
    /* Fix input group spacing */
    .input-group .form-control {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .input-group .btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    
    /* Fix textarea spacing */
    .form-group textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }
    
    /* Small text spacing */
    .form-group small {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        line-height: 1.4;
    }
    
    /* Fix item row form fields */
    .item-row .form-label {
        margin-bottom: 6px;
        font-size: 13px;
        font-weight: 600;
    }
    
    .item-row .form-control {
        padding: 8px 12px;
        font-size: 13px;
        margin-bottom: 0;
    }
    
    .item-row .col-md-1,
    .item-row .col-md-2,
    .item-row .col-md-3 {
        padding-right: 8px;
        padding-left: 8px;
    }
    
    /* Fix form check styling */
    .form-check {
        margin-bottom: 15px;
    }
    
    .form-check-label {
        margin-left: 8px;
        font-size: 14px;
        line-height: 1.5;
    }
    
    /* Ensure proper spacing for switch toggles */
    .form-check-input[type="checkbox"] {
        margin-top: 0.25rem;
    }
    
    /* Override Material Dashboard floating label conflicts */
    .invoice-creator .input-group-outline {
        position: relative;
        background: transparent;
        border-radius: 0.375rem;
    }
    
    .invoice-creator .input-group-outline .form-label {
        position: static !important;
        transform: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin-bottom: 8px !important;
        color: #344767 !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        line-height: 1.4 !important;
    }
    
    .invoice-creator .input-group-outline .form-control {
        background: #fff !important;
        border: 1px solid #d2d6da !important;
        padding: 12px 16px !important;
        margin-top: 0 !important;
    }
    
    .invoice-creator .input-group-outline .form-control:focus {
        border-color: #e91e63 !important;
        box-shadow: 0 0 0 0.2rem rgba(233, 30, 99, 0.25) !important;
    }

    /* Responsive scrolling for mobile devices */
    @media (max-width: 768px) {
        .invoice-creator {
            flex-direction: column;
            gap: 15px;
        }

        .form-section,
        .preview-section {
            max-height: 70vh;
            overflow-x: auto;
            overflow-y: auto;
        }

        /* Enable horizontal scrolling for forms */
        .form-section {
            min-width: 100%;
            overflow-x: auto;
        }

        /* Enable horizontal scrolling for preview */
        .preview-section {
            min-width: 100%;
            overflow-x: auto;
        }

        /* Make the invoice preview scrollable horizontally */
        .invoice-preview {
            min-width: 600px;
            /* Ensure minimum width for readability */
            overflow-x: auto;
        }

        /* Improve form inputs on mobile */
        .form-control,
        .form-select {
            min-width: 200px;
        }

        /* Make tables scrollable on mobile */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Adjust container padding for mobile */
        .container-fluid {
            padding-left: 10px;
            padding-right: 10px;
        }
    }

    /* Additional responsive breakpoints for very small screens */
    @media (max-width: 480px) {

        .form-section,
        .preview-section {
            padding: 15px;
            max-height: 60vh;
        }

        .invoice-preview {
            min-width: 500px;
            /* Slightly smaller for very small screens */
            padding: 20px;
        }

        /* Stack form elements vertically on very small screens */
        .row .col-md-6 {
            margin-bottom: 15px;
        }
    }

    /* Ensure all containers allow full content */
    .container-fluid,
    .row,
    .col-12,
    .card,
    .card-body {
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
    }

    .form-section {
        flex: 1;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 90vh;
        overflow-y: auto;
        overflow-x: auto;
        min-width: 0;
        /* Allow flexbox to shrink */
        /* Improve mouse wheel scrolling */
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }

    .preview-section {
        flex: 1;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        height: 85vh;
        max-height: 85vh;
        overflow-y: auto;
        overflow-x: auto;
        position: relative;
        min-width: 0;
        /* Allow flexbox to shrink */
        /* Improve mouse wheel scrolling */
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }

    /* Live Preview Styles */
    .invoice-preview {
        font-family: Arial, sans-serif;
        background: white;
        min-height: auto;
        height: auto;
        width: 100%;
        padding: 40px;
        margin: 0;
        box-sizing: border-box;
    }

    /* Add visual page break indicators for preview */
    .page-break-indicator {
        border-top: 2px dashed #ccc;
        margin: 40px 0;
        padding-top: 40px;
        position: relative;
    }

    .page-break-indicator::before {
        content: "--- Page Break ---";
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0 20px;
        font-size: 12px;
        color: #666;
        font-weight: bold;
    }

    /* Custom scrollbar styling for all scrollable elements */
    .preview-section::-webkit-scrollbar,
    .form-section::-webkit-scrollbar,
    .invoice-preview::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .preview-section::-webkit-scrollbar-track,
    .form-section::-webkit-scrollbar-track,
    .invoice-preview::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .preview-section::-webkit-scrollbar-thumb,
    .form-section::-webkit-scrollbar-thumb,
    .invoice-preview::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .preview-section::-webkit-scrollbar-thumb:hover,
    .form-section::-webkit-scrollbar-thumb:hover,
    .invoice-preview::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Corner where horizontal and vertical scrollbars meet */
    .preview-section::-webkit-scrollbar-corner,
    .form-section::-webkit-scrollbar-corner,
    .invoice-preview::-webkit-scrollbar-corner {
        background: #f1f1f1;
    }

    .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #e4e4e4;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    .company-logo img {
        max-height: 80px;
        max-width: 200px;
    }

    .company-details h2 {
        margin: 0;
        color: #333;
        font-size: 1.5em;
    }

    .company-details p {
        margin: 2px 0;
        color: #666;
        font-size: 0.9em;
    }

    .invoice-title {
        text-align: center;
        background: var(--primary-color);
        color: white;
        padding: 10px;
        margin: 20px 0;
        font-size: 1.5em;
        font-weight: bold;
        border-radius: 8px;
    }

    .invoice-info {
        display: flex;
        justify-content: space-between;
        background: var(--primary-color);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .client-section {
        margin: 20px 0;
    }

    .client-section h3 {
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .items-table th,
    .items-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }

    .items-table th {
        background: var(--primary-color);
        color: white;
        font-weight: bold;
    }

    .totals-section {
        display: flex;
        justify-content: space-between;
        margin: 30px 0;
    }

    .totals-right {
        text-align: right;
        min-width: 300px;
    }

    .totals-right p {
        margin: 8px 0;
        padding: 5px 0;
    }

    .total-final {
        font-size: 1.3em;
        font-weight: bold;
        border-top: 2px solid #333;
        padding-top: 10px;
    }

    .signature-section {
        margin: 40px 0;
        text-align: center;
    }

    .signature-section img {
        max-width: 300px;
        max-height: 100px;
        border-top: 1px solid #333;
        padding-top: 10px;
    }

    /* Dynamic Row Styles */
    .item-row {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        background: #f8f9fa;
    }

    .remove-item {
        color: #dc3545;
        cursor: pointer;
        float: right;
        font-size: 1.2em;
    }

    /* Form Enhancement */
    .form-group {
        margin-bottom: 15px;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }

    .btn-add-item {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin: 10px 0;
    }

    .btn-add-item:hover {
        background: #218838;
    }

    /* Print Styles */
    @media print {

        /* Basic print setup */
        @page {
            margin: 0.5in;
            size: A4;
        }

        /* Hide form and UI elements */
        .form-section {
            display: none !important;
        }

        .card-header {
            display: none !important;
        }

        .btn,
        button {
            display: none !important;
        }

        .no-print,
        .page-break-indicator {
            display: none !important;
        }

        /* Reset all height restrictions for print */
        body {
            height: auto !important;
            min-height: auto !important;
            max-height: none !important;
            overflow: visible !important;
        }

        /* Make preview section take full page */
        .invoice-creator {
            display: block !important;
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
        }

        .preview-section {
            width: 100% !important;
            flex: none !important;
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .invoice-preview {
            box-shadow: none !important;
            max-height: none !important;
            height: auto !important;
            font-size: 12px;
            padding: 0 !important;
            background: white !important;
            overflow: visible !important;
            page-break-inside: auto;
        }

        /* Maintain colors in print */
        .invoice-title {
            background: #FF5900 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .invoice-info {
            background: #FF5900 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .items-table th {
            background: #FF5900 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .client-section h3 {
            color: #FF5900 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Ensure borders and styling print */
        .items-table th,
        .items-table td {
            border: 1px solid #ddd !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .invoice-header {
            border-bottom: 2px solid #e4e4e4 !important;
        }

        .total-final {
            border-top: 2px solid #333 !important;
        }

        /* Ensure tables and rows break properly */
        .items-table {
            page-break-inside: auto;
            border-collapse: collapse !important;
            width: 100% !important;
        }

        .items-table tbody tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        .items-table thead {
            display: table-header-group;
        }

        .items-table tbody {
            display: table-row-group;
        }

        /* Prevent widow/orphan lines */
        p,
        div {
            orphans: 3;
            widows: 3;
        }

        /* Ensure signatures and footers stay together */
        .signature-section,
        .terms-section,
        .bank-details {
            page-break-inside: avoid;
        }

        /* Force all content to be visible */
        .container-fluid,
        .row,
        .col-12,
        .card,
        .card-body,
        .invoice-creator,
        .form-section,
        .preview-section,
        .invoice-preview {
            height: auto !important;
            min-height: auto !important;
            max-height: none !important;
            overflow: visible !important;
            position: static !important;
        }

        /* Ensure tables show all rows */
        .items-table,
        .items-table tbody,
        .items-table thead {
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
        }

        /* Remove any viewport constraints */
        html,
        body {
            height: auto !important;
            min-height: auto !important;
            max-height: none !important;
            overflow: visible !important;
            margin: 0 !important;
            padding: 0 !important;
            print-color-adjust: exact !important;
            -webkit-print-color-adjust: exact !important;
        }

        /* Ensure all table content is visible */
        .items-table tbody tr,
        .items-table tbody td {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* Hide everything by default */
        * {
            visibility: hidden !important;
        }

        /* Show only invoice content */
        .invoice-preview,
        .invoice-preview * {
            visibility: visible !important;
        }

        /* Restore specific display types for invoice content only */
        .invoice-preview .items-table {
            display: table !important;
            visibility: visible !important;
        }

        .invoice-preview .items-table thead {
            display: table-header-group !important;
            visibility: visible !important;
        }

        .invoice-preview .items-table tbody {
            display: table-row-group !important;
            visibility: visible !important;
        }

        .invoice-preview .items-table tr {
            display: table-row !important;
            visibility: visible !important;
        }

        .invoice-preview .items-table th,
        .invoice-preview .items-table td {
            display: table-cell !important;
            visibility: visible !important;
        }

        /* Inline elements */
        .invoice-preview span,
        .invoice-preview strong,
        .invoice-preview em {
            display: inline !important;
            visibility: visible !important;
        }

        /* Flex containers */
        .invoice-preview .invoice-header,
        .invoice-preview .invoice-info,
        .invoice-preview .totals-section {
            display: flex !important;
            visibility: visible !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card my-4">
                <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                    <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3 no-print">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="text-white text-capitalize ps-3 no-print">{{ title }}</h6>
                            <div class="pe-3 no-print">

                                {% comment %} <button onclick="printInvoice()"
                                    class="btn btn-outline-white btn-sm me-2 no-print">
                                    <i class="material-icons text-sm">print</i> Print All Pages
                                </button> {% endcomment %}

                                <button id="download-invoice-btn" class="btn btn-outline-white btn-sm me-2 no-print">
                                    <i class="material-icons text-sm">download</i> Download & Print Invoice
                                </button>

                                <button onclick="saveInvoice()" class="btn btn-outline-white btn-sm no-print">
                                    <i class="material-icons text-sm">save</i> Save Invoice
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <form id="invoice-form" method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="invoice-creator">
                            <!-- Form Section -->
                            <div class="form-section">
                                <h5 class="mb-4">Invoice Details</h5>

                                <!-- Currency Settings -->
                                <div class="form-group">
                                    <label class="form-label">Currency Settings</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Currency Code</label>
                                            <select id="currency_code" name="currency_code" class="form-control">
                                                <option value="USD" data-symbol="$" {% if company_profile.currency_code == "USD" %}selected{% endif %}>USD - US Dollar ($)</option>
                                                <option value="EUR" data-symbol="€" {% if company_profile.currency_code == "EUR" %}selected{% endif %}>EUR - Euro (€)</option>
                                                <option value="GBP" data-symbol="£" {% if company_profile.currency_code == "GBP" %}selected{% endif %}>GBP - British Pound (£)</option>
                                                <option value="NGN" data-symbol="₦" {% if company_profile.currency_code == "NGN" or not company_profile.currency_code %}selected{% endif %}>NGN - Nigerian Naira (₦)</option>
                                                <option value="JPY" data-symbol="¥" {% if company_profile.currency_code == "JPY" %}selected{% endif %}>JPY - Japanese Yen (¥)</option>
                                                <option value="CNY" data-symbol="¥" {% if company_profile.currency_code == "CNY" %}selected{% endif %}>CNY - Chinese Yuan (¥)</option>
                                                <option value="INR" data-symbol="₹" {% if company_profile.currency_code == "INR" %}selected{% endif %}>INR - Indian Rupee (₹)</option>
                                                <option value="AUD" data-symbol="A$" {% if company_profile.currency_code == "AUD" %}selected{% endif %}>AUD - Australian Dollar (A$)</option>
                                                <option value="CAD" data-symbol="C$" {% if company_profile.currency_code == "CAD" %}selected{% endif %}>CAD - Canadian Dollar (C$)</option>
                                                <option value="CHF" data-symbol="Fr" {% if company_profile.currency_code == "CHF" %}selected{% endif %}>CHF - Swiss Franc (Fr)</option>
                                                <option value="KRW" data-symbol="₩" {% if company_profile.currency_code == "KRW" %}selected{% endif %}>KRW - South Korean Won (₩)</option>
                                                <option value="SGD" data-symbol="S$" {% if company_profile.currency_code == "SGD" %}selected{% endif %}>SGD - Singapore Dollar (S$)</option>
                                                <option value="HKD" data-symbol="HK$" {% if company_profile.currency_code == "HKD" %}selected{% endif %}>HKD - Hong Kong Dollar (HK$)</option>
                                                <option value="ZAR" data-symbol="R" {% if company_profile.currency_code == "ZAR" %}selected{% endif %}>ZAR - South African Rand (R)</option>
                                                <option value="BRL" data-symbol="R$" {% if company_profile.currency_code == "BRL" %}selected{% endif %}>BRL - Brazilian Real (R$)</option>
                                                <option value="MXN" data-symbol="$" {% if company_profile.currency_code == "MXN" %}selected{% endif %}>MXN - Mexican Peso ($)</option>
                                                <option value="SAR" data-symbol="﷼" {% if company_profile.currency_code == "SAR" %}selected{% endif %}>SAR - Saudi Riyal (﷼)</option>
                                                <option value="AED" data-symbol="د.إ" {% if company_profile.currency_code == "AED" %}selected{% endif %}>AED - UAE Dirham (د.إ)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Currency Symbol</label>
                                            <input type="text" id="currency_symbol" name="currency_symbol"
                                                class="form-control" value="{{ currency_symbol|default:'₦' }}" readonly>
                                            <small class="text-muted">Automatically updated when currency code
                                                changes</small>
                                        </div>
                                    </div>

                                </div>

                                <!-- Company Details Toggle -->
                                <div class="form-group">
                                    <label class="form-label">Company Information Display</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="show-company-details"
                                            checked>
                                        <label class="form-check-label" for="show-company-details">
                                            Show my company details on invoice
                                        </label>
                                    </div>
                                    {% if company_profile %}
                                    <small class="text-muted">
                                        Current details: {{ company_profile.company_name|default:"Not set" }},
                                        {{ company_profile.email|default:"No email" }}
                                        {% if not company_profile.company_name or not company_profile.email %}
                                        - <a href="{% url 'core:company_profile' %}" target="_blank">Update profile</a>
                                        {% endif %}
                                    </small>
                                    {% else %}
                                    <small class="text-warning">
                                        No company profile found - <a href="{% url 'core:company_profile' %}"
                                            target="_blank">Create profile</a>
                                    </small>
                                    {% endif %}
                                </div>

                                <!-- Bank Details Toggle -->
                                <div class="form-group">
                                    <label class="form-label">Bank Details Display</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="show-bank-details" {% if default_bank_account %}checked{% endif %}>
                                        <label class="form-check-label" for="show-bank-details">
                                            Show bank details on invoice
                                        </label>
                                    </div>
                                    {% if default_bank_account %}
                                    <small class="text-muted">
                                        Bank: {{ default_bank_account.bank_name }} - {{
                                        default_bank_account.account_number }}
                                        {% if not default_bank_account.is_default %}
                                        (First account) - <a href="{% url 'core:bank_accounts' %}"
                                            target="_blank">Manage accounts</a>
                                        {% else %}
                                        (Default) - <a href="{% url 'core:bank_accounts' %}" target="_blank">Manage
                                            accounts</a>
                                        {% endif %}
                                    </small>
                                    {% else %}
                                    <small class="text-warning">
                                        No bank account found - <a href="{% url 'core:bank_accounts' %}"
                                            target="_blank">Add bank account</a>
                                    </small>
                                    {% endif %}
                                </div>

                                <!-- Invoice Number -->
                                <div class="form-group">
                                    <label class="form-label">Invoice Number</label>
                                    <div class="input-group">
                                        <input type="text" id="invoice_number" name="invoice_number"
                                            class="form-control" placeholder="Auto-generated" value="">
                                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="regenerateInvoiceNumber()" title="Generate new invoice number">
                                            <i class="material-icons text-sm">refresh</i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Auto-generated or edit to customize. Click refresh to
                                        generate new number.</small>
                                </div>

                                <!-- Template Selection -->
                                {% if templates %}
                                <div class="form-group">
                                    <label class="form-label">Invoice Template</label>
                                    <select id="template" name="template" class="form-control">
                                        <option value="">Choose a template (optional)</option>
                                        {% for template in templates %}
                                            <option value="{{ template.id }}" 
                                                    {% if template.is_default %}selected{% endif %}
                                                    data-primary="{{ template.primary_color }}"
                                                    data-secondary="{{ template.secondary_color }}"
                                                    data-text="{{ template.text_color }}"
                                                    data-accent="{{ template.accent_color }}">
                                                {{ template.name }}
                                                {% if template.is_default %} (Default){% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">
                                    Choose a template to customize your invoice colors and styling.
                                    <a href="{% url 'invoices:template_list' %}" target="_blank">Manage templates</a> |
                                    <a href="javascript:void(0)" onclick="refreshTemplates()" class="text-primary">Refresh</a>
                                    </small>
                                      
                                      <!-- Color Test Indicator -->
                                      <div style="margin-top: 10px;">
                                          <span style="display: inline-block; width: 20px; height: 20px; background: var(--primary-color); border-radius: 3px; margin-right: 5px; vertical-align: middle;"></span>
                                          <small class="text-muted">Current primary color</small>
                                      </div>
                                </div>
                                {% endif %}

                                <!-- Client Information -->
                                <div class="form-group">
                                    <label class="form-label">Client Name *</label>
                                    <input type="text" id="client_name" name="client_name" class="form-control"
                                        placeholder="Enter client name" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Client Email</label>
                                    <input type="email" id="client_email" name="client_email" class="form-control"
                                        placeholder="client@example.com">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Client Phone</label>
                                    <input type="text" id="client_phone" name="client_phone" class="form-control"
                                        placeholder="+1234567890">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Client Address</label>
                                    <textarea id="client_address" name="client_address" class="form-control" rows="3"
                                        placeholder="Enter client address"></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Due Date *</label>
                                    <input type="date" id="due_date" name="due_date" class="form-control">
                                </div>

                                <!-- Invoice Items -->
                                <h6 class="mt-4 mb-3">Invoice Items</h6>
                                <div id="items-container">
                                    <div class="item-row" data-index="1">
                                        <span class="remove-item" onclick="removeItem(1)"
                                            style="display: none;">×</span>
                                        <div class="row">
                                            <div class="col-md-1">
                                                <label class="form-label">S/N</label>
                                                <input type="text" class="form-control item-serial" value="1" readonly
                                                    data-index="1"
                                                    style="background-color: #f8f9fa; text-align: center;">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Product/Service</label>
                                                <input type="text" name="items[1][product_service]"
                                                    class="form-control item-product" placeholder="Product/service name"
                                                    data-index="1">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Description</label>
                                                <input type="text" name="items[1][description]"
                                                    class="form-control item-description" placeholder="Item description"
                                                    data-index="1">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label"
                                                    title="You can mix text with numbers. System extracts numbers for calculation.">Qty.
                                                    <small>(text+numbers)</small></label>
                                                <input type="text" name="items[1][quantity]"
                                                    class="form-control item-quantity"
                                                    placeholder="e.g. 2 boxes, 1.5, 3+2" data-index="1"
                                                    title="Examples: '2 boxes', '1.5 kg', '3+2 sets'">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label"
                                                    title="You can mix text with numbers. System extracts numbers for calculation.">Cost
                                                    <small>(text+numbers)</small></label>
                                                <input type="text" name="items[1][unit_price]"
                                                    class="form-control item-price" placeholder="e.g. $10, 15.50 each"
                                                    data-index="1"
                                                    title="Examples: '$10 each', '15.50 per item', '20-2 discount'">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Total</label>
                                                <input type="text" class="form-control item-total" readonly
                                                    data-index="1">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn-add-item" onclick="addItem()">
                                    <i class="material-icons text-sm">add</i> Add Item
                                </button>

                                <!-- Financial Details -->
                                <h6 class="mt-4 mb-3">Additional Charges</h6>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Tax/VAT (%)</label>
                                            <input type="number" id="tax_rate" name="tax_rate" class="form-control"
                                                placeholder="7.5" step="0.01" value="{{ company_profile.default_tax }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Discount</label>
                                            <input type="text" id="discount" name="discount" class="form-control"
                                                placeholder="0.00" value="{{ company_profile.default_discount }}">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Shipping Fee</label>
                                            <input type="text" id="shipping_fee" name="shipping_fee"
                                                class="form-control" placeholder="0.00"
                                                value="{{ company_profile.default_shipping_fee }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Other Charges</label>
                                            <input type="text" id="other_charges" name="other_charges"
                                                class="form-control" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Amount Paid</label>
                                    <input type="text" id="amount_paid" name="amount_paid" class="form-control"
                                        placeholder="0.00">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <textarea id="notes" name="notes" class="form-control" rows="3"
                                        placeholder="Additional notes..."></textarea>
                                </div>
                            </div>

                            <!-- Live Preview Section -->
                            <div class="preview-section">
                                <div class="invoice-preview" id="invoice-preview">
                                    <!-- Invoice Header -->
                                    <div class="invoice-header">
                                        <div class="company-logo">
                                            {% if company_logo %}
                                            <img src="{{ company_logo }}" alt="Company Logo" id="preview-logo">
                                            {% else %}
                                            <img src="{% static 'img/logo-ct.png' %}" alt="Company Logo"
                                                id="preview-logo">
                                            {% endif %}
                                        </div>
                                        <div class="company-details">
                                            <h2 id="preview-company-name">{% if company_profile.company_name %}{{ company_profile.company_name }}{% else %}Your Company Name{% endif %}</h2>
                                            <p id="preview-company-address">{% if company_profile.address %}{{ company_profile.address }}{% else %}Company Address{% endif %}</p>
                                            <p id="preview-company-phone">{% if company_profile.phone %}{{ company_profile.phone }}{% else %}Phone Number{% endif %}</p>
                                            <p id="preview-company-email">{% if company_profile.email %}{{ company_profile.email }}{% else %}Email Address{% endif %}</p>
                                        </div>
                                    </div>

                                    <!-- Invoice Title -->
                                    <div class="invoice-title">INVOICE</div>

                                    <!-- Invoice Info -->
                                    <div class="invoice-info">
                                        <div>
                                            <strong>Invoice #: <span
                                                    id="preview-invoice-number">INV-DRAFT</span></strong>
                                        </div>
                                        <div>
                                            <strong>Date: <span id="preview-date"></span></strong>
                                        </div>
                                        <div>
                                            <strong>Due: <span id="preview-due-date">Select Date</span></strong>
                                        </div>
                                    </div>

                                    <!-- Client Section -->
                                    <div class="client-section">
                                        <h3>BILL TO:</h3>
                                        <div id="preview-client-info">
                                            <strong id="preview-client-name">Client Name</strong><br>
                                            <span id="preview-client-email"></span><br>
                                            <span id="preview-client-phone"></span><br>
                                            <span id="preview-client-address"></span>
                                        </div>
                                    </div>

                                    <!-- Items Table -->
                                    <table class="items-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 8%;">S/N</th>
                                                <th style="width: 20%;">PRODUCT / SERVICE</th>
                                                <th style="width: 30%;">DESCRIPTION</th>
                                                <th style="width: 10%;">QTY.</th>
                                                <th style="width: 15%;">COST</th>
                                                <th style="width: 17%;">TOTAL</th>
                                            </tr>
                                        </thead>
                                        <tbody id="preview-items">
                                            <tr>
                                                <td>1</td>
                                                <td>Sample Product</td>
                                                <td>Sample Description</td>
                                                <td>1</td>
                                                <td>{{ currency_symbol }}0.00</td>
                                                <td>{{ currency_symbol }}0.00</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <!-- Totals Section -->
                                    <div class="totals-section">
                                        <div class="totals-left">
                                            <p><strong>Thanks for your business!</strong></p>
                                            <div id="preview-notes"></div>
                                        </div>
                                        <div class="totals-right">
                                            <p>Subtotal: <span id="preview-subtotal">{{ currency_symbol }}0.00</span>
                                            </p>
                                            <p id="tax-line" style="display: none;">Tax (<span
                                                    id="preview-tax-rate">0</span>%): <span id="preview-tax">{{
                                                    currency_symbol }}0.00</span></p>
                                            <p id="discount-line" style="display: none;">Discount: -<span
                                                    id="preview-discount">{{ currency_symbol }}0.00</span></p>
                                            <p id="shipping-line" style="display: none;">Shipping: <span
                                                    id="preview-shipping">{{ currency_symbol }}0.00</span></p>
                                            <p id="other-line" style="display: none;">Other Charges: <span
                                                    id="preview-other">{{ currency_symbol }}0.00</span></p>
                                            <p class="total-final">TOTAL: <span id="preview-total">{{ currency_symbol
                                                    }}0.00</span></p>
                                            <p id="paid-line" style="display: none;">Amount Paid: <span
                                                    id="preview-paid">{{ currency_symbol }}0.00</span></p>
                                            <p id="balance-line" style="display: none;">Balance Due: <span
                                                    id="preview-balance">{{ currency_symbol }}0.00</span></p>
                                        </div>
                                    </div>

                                    <!-- Signature Section -->
                                    <div class="signature-section" style="margin-top: 30px;" id="signature-preview">
                                        {% if company_signature %}
                                        <img src="{{ company_signature }}" alt="Signature" id="preview-signature">
                                        <p><strong>Authorized Signature</strong></p>
                                        {% else %}
                                        <div style="border-top: 1px solid #333; width: 250px; margin: 0 auto; padding-top: 10px;">
                                            <p style="font-family: 'Brush Script MT', cursive; font-size: 18px; margin: 5px 0; color: #333;">{{ company_profile.company_name|default:"Company Name" }}</p>
                                            <p style="font-size: 11px; font-weight: bold; margin: 0;">Authorized Signature</p>
                                            <p style="font-size: 9px; color: #666; margin: 2px 0;">{{ company_profile.email|default:"" }}</p>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Bank Details Section -->
                                    <div class="bank-details-section" style="margin-top: 30px; display: none;" id="bank-details-preview">
                                        <h3 style="color: #FF5900; text-align: center; margin-bottom: 20px;">BANK
                                            DETAILS</h3>
                                        <div style="display: flex; justify-content: center; gap: 20px;">
                                            <div
                                                style="background-color: black; color: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19); text-align: center;">
                                                <p style="margin: 0; line-height: 1.6;">
                                                    <strong>Bank Name:</strong> <span id="preview-bank-name">{% if default_bank_account %}{{ default_bank_account.bank_name }}{% else %}Bank Name{% endif %}</span><br>
                                                    <strong>Account No:</strong> <span id="preview-account-number">{% if default_bank_account %}{{ default_bank_account.account_number }}{% else %}Account Number{% endif %}</span><br>
                                                    <strong>Account Name:</strong> <span id="preview-account-name">{% if default_bank_account %}{{ default_bank_account.account_name }}{% else %}Account Name{% endif %}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Company Data -->
<script type="application/json" id="company-data">
{
    "name": "{% if company_profile and company_profile.company_name %}{{ company_profile.company_name|escapejs }}{% else %}Your Company Name{% endif %}",
    "address": "{% if company_profile and company_profile.address %}{{ company_profile.address|escapejs }}{% else %}Company Address{% endif %}",
    "phone": "{% if company_profile and company_profile.phone %}{{ company_profile.phone|escapejs }}{% else %}Phone Number{% endif %}",
    "email": "{% if company_profile and company_profile.email %}{{ company_profile.email|escapejs }}{% else %}Email Address{% endif %}",
    "logo": "{% if company_logo %}{{ company_logo|escapejs }}{% else %}{% static 'img/logo-ct.png' %}{% endif %}"
}
</script>

<script>
    // IMMEDIATE LOADING OPTIMIZATION
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Starting page optimization...');
        
        // Hide loading overlay after short delay to ensure smooth transition
        const loadingOverlay = document.getElementById('loading-overlay');
        const invoiceCreator = document.querySelector('.invoice-creator');
        
        // Immediate loading - no unnecessary delays
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
            setTimeout(() => loadingOverlay.style.display = 'none', 200);
        }
        
        if (invoiceCreator) {
            invoiceCreator.classList.add('loaded');
        }
    });
</script>

<script>
    let itemCounter = 1;
    let currencySymbol = '{{ currency_symbol|default:"₦" }}';

    // Load company data from JSON
    const companyDataElement = document.getElementById('company-data');
    const companyData = JSON.parse(companyDataElement.textContent);
    const companyName = companyData.name;
    const companyAddress = companyData.address;
    const companyPhone = companyData.phone;
    const companyEmail = companyData.email;
    const companyLogo = companyData.logo;

    // Format currency
    function formatMoney(amount) {
        return currencySymbol + parseFloat(amount || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    // Update currency symbol throughout the form
    function updateCurrencySymbol(newSymbol) {
        currencySymbol = newSymbol;

        // Update all money displays in the preview
        const moneyElements = document.querySelectorAll('[id*="preview-"], .item-total, #currency_symbol');
        moneyElements.forEach(element => {
            if (element.id === 'currency_symbol') {
                element.value = newSymbol;
            } else if (element.textContent && element.textContent.match(/^[₦$€£¥₹R\$]+[\d,.]*/)) {
                // Re-format existing money values with new symbol
                const numericValue = parseFormattedInput(element.textContent);
                element.textContent = formatMoney(numericValue);
            }
        });

        // Update item totals
        document.querySelectorAll('.item-total').forEach(input => {
            if (input.value) {
                const numericValue = parseFormattedInput(input.value);
                input.value = formatMoney(numericValue);
            }
        });

        // Recalculate totals with new currency
        calculateTotals();
        updatePreview();
    }

    // Handle currency dropdown change
    function handleCurrencyChange() {
        const currencySelect = document.getElementById('currency_code');
        const selectedOption = currencySelect.options[currencySelect.selectedIndex];
        const newSymbol = selectedOption.getAttribute('data-symbol');

        updateCurrencySymbol(newSymbol);
    }



    // Update company details display based on toggle
    function updateCompanyDetailsDisplay() {
        const showDetails = document.getElementById('show-company-details').checked;
        const companyDetailsDiv = document.querySelector('.company-details');
        const companyLogoDiv = document.querySelector('.company-logo');

        if (showDetails) {
            // Show user's company details using predefined variables
            document.getElementById('preview-company-name').textContent = companyName;
            document.getElementById('preview-company-address').textContent = companyAddress;
            document.getElementById('preview-company-phone').textContent = companyPhone;
            document.getElementById('preview-company-email').textContent = companyEmail;
            document.getElementById('preview-logo').src = companyLogo;

            if (companyDetailsDiv) companyDetailsDiv.style.display = 'block';
            if (companyLogoDiv) companyLogoDiv.style.display = 'block';
        } else {
            // Hide company details
            if (companyDetailsDiv) companyDetailsDiv.style.display = 'none';
            if (companyLogoDiv) companyLogoDiv.style.display = 'none';
        }
    }

    // Update bank details display based on toggle
    function updateBankDetailsDisplay() {
        const showDetails = document.getElementById('show-bank-details').checked;
        const bankDetailsSection = document.getElementById('bank-details-preview');

        if (bankDetailsSection) {
            if (showDetails) {
                // Show bank details and populate with backend data
                bankDetailsSection.style.display = 'block';
                
                // Update bank details from backend data if available
                const bankName = '{% if default_bank_account %}{{ default_bank_account.bank_name|escapejs }}{% else %}{% endif %}';
                const accountNumber = '{% if default_bank_account %}{{ default_bank_account.account_number|escapejs }}{% else %}{% endif %}';
                const accountName = '{% if default_bank_account %}{{ default_bank_account.account_name|escapejs }}{% else %}{% endif %}';
                
                if (bankName) {
                    document.getElementById('preview-bank-name').textContent = bankName;
                }
                if (accountNumber) {
                    document.getElementById('preview-account-number').textContent = accountNumber;
                }
                if (accountName) {
                    document.getElementById('preview-account-name').textContent = accountName;
                }
            } else {
                bankDetailsSection.style.display = 'none';
            }
        }
    }

    // Parse formatted input (handles currency symbols, commas, text mixed with numbers)
    function parseFormattedInput(input) {
        if (!input) return 0;

        // Convert to string and clean it
        let inputStr = input.toString().trim();

        // If it's already a clean number, return it
        if (/^-?\d*\.?\d+$/.test(inputStr)) {
            return parseFloat(inputStr) || 0;
        }

        // Remove currency symbols and commas first
        inputStr = inputStr.replace(/[₦$€£¥₹,]/g, '');

        // Handle percentage inputs
        if (inputStr.includes('%')) {
            const percentValue = parseFloat(inputStr.replace('%', ''));
            return isNaN(percentValue) ? 0 : percentValue / 100;
        }

        // Handle special notations like 'k' for thousands, 'm' for millions
        if (inputStr.toLowerCase().endsWith('k')) {
            const baseValue = parseFloat(inputStr.slice(0, -1));
            return isNaN(baseValue) ? 0 : baseValue * 1000;
        }

        if (inputStr.toLowerCase().endsWith('m')) {
            const baseValue = parseFloat(inputStr.slice(0, -1));
            return isNaN(baseValue) ? 0 : baseValue * 1000000;
        }

        // Find all number patterns (including negative numbers and decimals)
        const numberMatches = inputStr.match(/-?\d+(?:\.\d+)?/g);

        if (!numberMatches || numberMatches.length === 0) {
            return 0;
        }

        // If only one number, return it
        if (numberMatches.length === 1) {
            return parseFloat(numberMatches[0]) || 0;
        }

        // If multiple numbers, evaluate basic math operations
        let total = 0;
        let operation = '+'; // Default operation

        for (let i = 0; i < numberMatches.length; i++) {
            const num = parseFloat(numberMatches[i]);
            if (!isNaN(num)) {
                if (i === 0) {
                    // First number is always the starting value
                    total = num;
                } else {
                    // Look for operators between this and previous number
                    const prevNumberIndex = inputStr.lastIndexOf(numberMatches[i - 1]);
                    const currentNumberIndex = inputStr.indexOf(numberMatches[i], prevNumberIndex + numberMatches[i - 1].length);
                    const textBetween = inputStr.substring(prevNumberIndex + numberMatches[i - 1].length, currentNumberIndex);

                    // Determine operation based on text between numbers
                    if (textBetween.includes('-') || textBetween.toLowerCase().includes('minus') || textBetween.toLowerCase().includes('less')) {
                        total -= num;
                    } else if (textBetween.includes('+') || textBetween.toLowerCase().includes('plus') || textBetween.toLowerCase().includes('add')) {
                        total += num;
                    } else if (textBetween.includes('*') || textBetween.includes('x') || textBetween.toLowerCase().includes('times')) {
                        total *= num;
                    } else if (textBetween.includes('/') || textBetween.toLowerCase().includes('divide')) {
                        total = num !== 0 ? total / num : total;
                    } else {
                        // Default to addition if no clear operator
                        total += num;
                    }
                }
            }
        }

        // Round to 2 decimal places to avoid floating point precision issues
        return Math.round(total * 100) / 100;
    }

    // Get display value (preserves original text with mixed content)
    function getDisplayValue(input) {
        return input ? input.toString() : '';
    }

    // Add new item row
    function addItem() {
        itemCounter++;
        const container = document.getElementById('items-container');

        const itemRow = document.createElement('div');
        itemRow.className = 'item-row';
        itemRow.setAttribute('data-index', itemCounter);
        itemRow.innerHTML = `
        <span class="remove-item" onclick="removeItem(${itemCounter})">×</span>
        <div class="row">
            <div class="col-md-1">
                <label class="form-label">S/N</label>
                <input type="text" class="form-control item-serial" value="${itemCounter}" readonly data-index="${itemCounter}" style="background-color: #f8f9fa; text-align: center;">
            </div>
            <div class="col-md-2">
                <label class="form-label">Product/Service</label>
                <input type="text" name="items[${itemCounter}][product_service]" class="form-control item-product" 
                       placeholder="Product/service name" data-index="${itemCounter}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Description</label>
                <input type="text" name="items[${itemCounter}][description]" class="form-control item-description" 
                       placeholder="Item description" data-index="${itemCounter}">
            </div>
            <div class="col-md-2">
                <label class="form-label" title="You can mix text with numbers. System extracts numbers for calculation.">Qty. <small>(text+numbers)</small></label>
                <input type="text" name="items[${itemCounter}][quantity]" class="form-control item-quantity" 
                       placeholder="e.g. 2 boxes, 1.5, 3+2" data-index="${itemCounter}" title="Examples: '2 boxes', '1.5 kg', '3+2 sets'">
            </div>
            <div class="col-md-2">
                <label class="form-label" title="You can mix text with numbers. System extracts numbers for calculation.">Cost <small>(text+numbers)</small></label>
                <input type="text" name="items[${itemCounter}][unit_price]" class="form-control item-price" 
                       placeholder="e.g. $10, 15.50 each" data-index="${itemCounter}" title="Examples: '$10 each', '15.50 per item', '20-2 discount'">
            </div>
            <div class="col-md-2">
                <label class="form-label">Total</label>
                <input type="text" class="form-control item-total" readonly data-index="${itemCounter}">
            </div>
        </div>
    `;

        container.appendChild(itemRow);

        // Add event listeners to new inputs
        addItemEventListeners(itemCounter);

        // Recalculate serial numbers
        recalculateSerialNumbers();

        // Show remove buttons if more than one item
        updateRemoveButtons();

        // Update preview
        updatePreview();

        // Add page break indicators
        setTimeout(() => {
            addPageBreakIndicators();
        }, 100);
    }

    // Remove item row
    function removeItem(index) {
        const itemRow = document.querySelector(`[data-index="${index}"]`);
        if (itemRow) {
            itemRow.remove();
            recalculateSerialNumbers();
            updateRemoveButtons();
            updatePreview();
        }
    }

    // Update remove button visibility
    function updateRemoveButtons() {
        const items = document.querySelectorAll('.item-row');
        const removeButtons = document.querySelectorAll('.remove-item');

        removeButtons.forEach(btn => {
            btn.style.display = items.length > 1 ? 'block' : 'none';
        });
    }

    // Recalculate serial numbers for all items
    function recalculateSerialNumbers() {
        const items = document.querySelectorAll('.item-row');
        items.forEach((item, index) => {
            const serialInput = item.querySelector('.item-serial');
            if (serialInput) {
                serialInput.value = index + 1;
            }
        });
    }

    // Add event listeners to item inputs
    function addItemEventListeners(index) {
        const productInput = document.querySelector(`[data-index="${index}"].item-product`);
        const descInput = document.querySelector(`[data-index="${index}"].item-description`);
        const qtyInput = document.querySelector(`[data-index="${index}"].item-quantity`);
        const priceInput = document.querySelector(`[data-index="${index}"].item-price`);
        const totalInput = document.querySelector(`[data-index="${index}"].item-total`);

        [productInput, descInput, qtyInput, priceInput].forEach(input => {
            if (input) {
                input.addEventListener('input', () => {
                    calculateItemTotal(index);
                    updatePreview();
                });
            }
        });
    }

    // Calculate individual item total with improved accuracy
    function calculateItemTotal(index) {
        const qtyInput = document.querySelector(`[data-index="${index}"].item-quantity`);
        const priceInput = document.querySelector(`[data-index="${index}"].item-price`);
        const totalInput = document.querySelector(`[data-index="${index}"].item-total`);

        if (qtyInput && priceInput && totalInput) {
            // Extract numeric values for calculation
            const qty = parseFormattedInput(qtyInput.value || '0');
            const price = parseFormattedInput(priceInput.value || '0');

            // Calculate total with precision (handles positive and negative values)
            const total = Math.round((qty * price) * 100) / 100;

            // Update display
            totalInput.value = formatMoney(total);

            // Store calculated values for accurate totals calculation
            qtyInput.setAttribute('data-calc-value', qty);
            priceInput.setAttribute('data-calc-value', price);
            totalInput.setAttribute('data-calc-value', total);

            // Trigger totals recalculation
            calculateTotals();

            // Log individual item calculation for debugging
            console.log(`Item ${index} calculation:`, {
                qtyInput: qtyInput.value,
                priceInput: priceInput.value,
                qty,
                price,
                total
            });
        }
    }

    // Calculate all totals with improved accuracy
    function calculateTotals() {
        let subtotal = 0;

        // Sum all item totals - use data-calc-value for accuracy if available
        document.querySelectorAll('.item-total').forEach(input => {
            const calcValue = input.getAttribute('data-calc-value');
            if (calcValue !== null && calcValue !== undefined) {
                subtotal += parseFloat(calcValue) || 0;
            } else {
                subtotal += parseFormattedInput(input.value);
            }
        });

        // Round subtotal to avoid floating point issues
        subtotal = Math.round(subtotal * 100) / 100;

        // Get additional charges with better parsing
        const taxRateElement = document.getElementById('tax_rate');
        const discountElement = document.getElementById('discount');
        const shippingElement = document.getElementById('shipping_fee');
        const otherElement = document.getElementById('other_charges');
        const amountPaidElement = document.getElementById('amount_paid');

        const taxRate = taxRateElement ? (parseFloat(taxRateElement.value) || 0) : 0;
        const discount = discountElement ? parseFormattedInput(discountElement.value) : 0;
        const shipping = shippingElement ? parseFormattedInput(shippingElement.value) : 0;
        const other = otherElement ? parseFormattedInput(otherElement.value) : 0;
        const amountPaid = amountPaidElement ? parseFormattedInput(amountPaidElement.value) : 0;

        // Calculate tax amount based on subtotal
        const tax = Math.round((subtotal * (taxRate / 100)) * 100) / 100;

        // Calculate total with precision
        const total = Math.round((subtotal + tax + shipping + other - discount) * 100) / 100;
        const balance = Math.round((total - amountPaid) * 100) / 100;

        // Update preview with null-checks
        const elements = {
            'preview-subtotal': subtotal,
            'preview-tax': tax,
            'preview-tax-rate': taxRate,
            'preview-discount': discount,
            'preview-shipping': shipping,
            'preview-other': other,
            'preview-total': total,
            'preview-paid': amountPaid,
            'preview-balance': balance
        };

        // Safely update each element
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                if (id === 'preview-tax-rate') {
                    element.textContent = value + '%';
                } else {
                    element.textContent = formatMoney(value);
                }
            }
        });

        // Show/hide lines based on values with null-checks
        const lines = [
            { id: 'tax-line', condition: tax > 0 },
            { id: 'discount-line', condition: discount > 0 },
            { id: 'shipping-line', condition: shipping > 0 },
            { id: 'other-line', condition: other > 0 },
            { id: 'paid-line', condition: amountPaid > 0 },
            { id: 'balance-line', condition: amountPaid > 0 }
        ];

        lines.forEach(line => {
            const element = document.getElementById(line.id);
            if (element) {
                element.style.display = line.condition ? 'block' : 'none';
            }
        });

        // Log for debugging (remove in production)
        console.log('Calculation Summary:', {
            subtotal,
            taxRate: taxRate + '%',
            tax,
            discount,
            shipping,
            other,
            total,
            amountPaid,
            balance
        });
    }

    // Update live preview
    function updatePreview() {
        // Update invoice number (but don't auto-generate if user is editing)
        const invoiceNumberInput = document.getElementById('invoice_number');
        const previewInvoiceNumber = document.getElementById('preview-invoice-number');
        if (invoiceNumberInput.value.trim()) {
            previewInvoiceNumber.textContent = invoiceNumberInput.value.trim();
        }

        // Update client info
        document.getElementById('preview-client-name').textContent =
            document.getElementById('client_name').value || 'Client Name';
        document.getElementById('preview-client-email').textContent =
            document.getElementById('client_email').value;
        document.getElementById('preview-client-phone').textContent =
            document.getElementById('client_phone').value;
        document.getElementById('preview-client-address').textContent =
            document.getElementById('client_address').value;

        // Update dates
        document.getElementById('preview-due-date').textContent =
            document.getElementById('due_date').value || 'No Due Date';

        // Update items table
        const previewItems = document.getElementById('preview-items');
        previewItems.innerHTML = '';

        document.querySelectorAll('.item-row').forEach((row, index) => {
            const serial = index + 1;
            const product = row.querySelector('.item-product').value || 'Product/Service';
            const desc = row.querySelector('.item-description').value || 'Item Description';

            // Get original text values for display (preserves user's text + numbers)
            const qtyInput = row.querySelector('.item-quantity');
            const priceInput = row.querySelector('.item-price');
            const totalInput = row.querySelector('.item-total');

            const qtyDisplay = getDisplayValue(qtyInput.value) || '0';
            const priceDisplay = getDisplayValue(priceInput.value) || '0.00';
            const total = totalInput.value || formatMoney(0);

            // Add visual indicator if the field contains mixed text/numbers
            const qtyHasText = qtyInput.value && !/^-?\d*\.?\d*$/.test(qtyInput.value.trim());
            const priceHasText = priceInput.value && !/^[$€£¥₹]?-?\d*\.?\d*$/.test(priceInput.value.trim());

            const qtyStyle = qtyHasText ? 'font-style: italic; color: #666;' : '';
            const priceStyle = priceHasText ? 'font-style: italic; color: #666;' : '';

            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td style="text-align: center; font-weight: bold;">${serial}</td>
            <td>${product}</td>
            <td>${desc}</td>
            <td style="${qtyStyle}" title="${qtyHasText ? 'Calculated: ' + parseFormattedInput(qtyInput.value) : ''}">${qtyDisplay}</td>
            <td style="${priceStyle}" title="${priceHasText ? 'Calculated: ' + formatMoney(parseFormattedInput(priceInput.value)) : ''}">${priceDisplay}</td>
            <td>${total}</td>
        `;
            previewItems.appendChild(tr);
        });

        // Update notes
        document.getElementById('preview-notes').innerHTML =
            document.getElementById('notes').value.replace(/\n/g, '<br>');

        // Calculate totals
        calculateTotals();

        // Add page break indicators after content updates
        setTimeout(() => {
            addPageBreakIndicators();
        }, 200);
    }

    // Add page break indicators to preview
    function addPageBreakIndicators() {
        const preview = document.querySelector('.invoice-preview');
        if (!preview) return;

        // Remove existing page break indicators
        preview.querySelectorAll('.page-break-indicator').forEach(el => el.remove());

        // Approximate page height (A4 at 96 DPI minus margins)
        const pageHeight = 1056; // roughly 11 inches * 96 DPI
        const children = Array.from(preview.children);
        let currentHeight = 0;
        let pageNumber = 1;

        children.forEach((child, index) => {
            const childHeight = child.offsetHeight;
            currentHeight += childHeight;

            // If we exceed page height, add a page break indicator
            if (currentHeight > pageHeight && index < children.length - 1) {
                const pageBreak = document.createElement('div');
                pageBreak.className = 'page-break-indicator';
                pageBreak.dataset.page = ++pageNumber;

                // Insert after current element
                if (child.nextSibling) {
                    preview.insertBefore(pageBreak, child.nextSibling);
                } else {
                    preview.appendChild(pageBreak);
                }

                currentHeight = 0; // Reset for next page
            }
        });
    }

    // Print invoice - ensures all content prints
    function printInvoice() {
        // Remove page break indicators for printing
        const indicators = document.querySelectorAll('.page-break-indicator');
        indicators.forEach(indicator => indicator.style.display = 'none');

        // Ensure preview section is fully expanded for printing
        const previewSection = document.querySelector('.preview-section');
        const originalHeight = previewSection.style.height;
        const originalMaxHeight = previewSection.style.maxHeight;
        const originalOverflow = previewSection.style.overflow;

        // Temporarily expand preview for printing
        previewSection.style.height = 'auto';
        previewSection.style.maxHeight = 'none';
        previewSection.style.overflow = 'visible';

        // Print
        window.print();

        // Restore original preview styling after print dialog
        setTimeout(() => {
            previewSection.style.height = originalHeight;
            previewSection.style.maxHeight = originalMaxHeight;
            previewSection.style.overflow = originalOverflow;

            // Restore page break indicators
            indicators.forEach(indicator => indicator.style.display = 'block');
        }, 1000);
    }

    // Download invoice as PDF
    async function downloadInvoice() {
        // Immediate user feedback
        const downloadBtn = document.getElementById('download-invoice-btn');
        const originalText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<i class="material-icons text-sm">hourglass_empty</i> Processing...';
        downloadBtn.disabled = true;
        
        try {
            console.log('🖨️ Starting invoice download/print process...');
            
            // Get the invoice preview element
            const element = document.querySelector('.invoice-preview');
            if (!element) {
                alert('No invoice preview found to print.');
                return;
            }
            
            // Immediate preview popup - no waiting for library
            console.log('📄 Opening print preview...');

        // Create a new window for printing
        const printWindow = window.open('', '_blank');

        // Copy the invoice content with proper styling
        const invoiceContent = element.cloneNode(true);

        // Remove any hidden elements or indicators
        const indicators = invoiceContent.querySelectorAll('.page-break-indicator');
        indicators.forEach(indicator => indicator.remove());

        // Get current template colors
        const computedStyles = getComputedStyle(document.documentElement);
        const primaryColor = computedStyles.getPropertyValue('--primary-color').trim() || '#FF5900';
        const secondaryColor = computedStyles.getPropertyValue('--secondary-color').trim() || '#f8f9fa';
        const textColor = computedStyles.getPropertyValue('--text-color').trim() || '#333333';
        const accentColor = computedStyles.getPropertyValue('--accent-color').trim() || '#e9ecef';
        
        console.log('🎨 Using template colors for print:', { primaryColor, secondaryColor, textColor, accentColor });

        // Create the print document
        printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Invoice</title>
            <style>
                /* Template color variables */
                :root {
                    --primary-color: ${primaryColor};
                    --secondary-color: ${secondaryColor};
                    --text-color: ${textColor};
                    --accent-color: ${accentColor};
                }
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 14px;
                    line-height: 1.6;
                    color: var(--text-color);
                    background: white;
                    padding: 20px;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .invoice-preview {
                    max-width: 800px;
                    margin: 0 auto;
                    background: white;
                    padding: 30px;
                    box-shadow: none;
                    border: 2px solid var(--accent-color);
                    border-radius: 10px;
                }
                
                .invoice-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 30px;
                    padding-bottom: 20px;
                    border-bottom: 2px solid #eee;
                }
                
                .company-logo img {
                    max-height: 80px;
                    max-width: 200px;
                }
                
                .company-details h2 {
                    color: var(--text-color);
                    margin-bottom: 10px;
                    font-size: 24px;
                }
                
                .company-details p {
                    margin: 5px 0;
                    color: var(--text-color);
                }
                
                .invoice-title {
                    text-align: center;
                    font-size: 36px;
                    font-weight: bold;
                    color: var(--primary-color) !important;
                    margin: 20px 0 30px 0;
                    text-transform: uppercase;
                    letter-spacing: 2px;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .invoice-info {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 30px;
                    padding: 15px;
                    background: var(--secondary-color) !important;
                    border-radius: 8px;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .client-info {
                    margin-bottom: 30px;
                }
                
                .client-info h4 {
                    color: var(--primary-color) !important;
                    margin-bottom: 10px;
                    border-bottom: 1px solid var(--accent-color);
                    padding-bottom: 5px;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .items-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 30px 0;
                    background: white;
                }
                
                .items-table th,
                .items-table td {
                    padding: 12px;
                    text-align: left;
                    border: 1px solid #ddd;
                }
                
                .items-table th {
                    background: var(--primary-color) !important;
                    color: white !important;
                    font-weight: bold;
                    text-transform: uppercase;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .items-table tr:nth-child(even) {
                    background: var(--secondary-color) !important;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .totals-section {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin: 30px 0;
                    padding: 20px;
                    background: var(--secondary-color) !important;
                    border-radius: 8px;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .totals-right {
                    text-align: right;
                    min-width: 250px;
                }
                
                .totals-right p {
                    margin: 8px 0;
                    padding: 5px 0;
                }
                
                .total-final {
                    font-size: 18px;
                    font-weight: bold;
                    color: var(--primary-color) !important;
                    border-top: 2px solid var(--primary-color) !important;
                    padding-top: 10px !important;
                    margin-top: 10px !important;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .signature-section {
                    text-align: center;
                    margin: 40px 0 30px 0;
                    padding: 20px;
                }
                
                .signature-section img {
                    max-height: 80px;
                    margin-bottom: 10px;
                }
                
                .bank-details-section {
                    margin: 30px 0;
                    text-align: center;
                }
                
                .bank-details-section h3 {
                    color: var(--primary-color) !important;
                    margin-bottom: 20px;
                    font-size: 20px;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .bank-details-section > div {
                    display: flex;
                    justify-content: center;
                    gap: 20px;
                }
                
                .bank-details-section > div > div {
                    background-color: #333 !important;
                    color: white !important;
                    padding: 20px;
                    border-radius: 15px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 6px 20px rgba(0,0,0,0.19) !important;
                    min-width: 300px;
                    -webkit-print-color-adjust: exact;
                    color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .bank-details-section p {
                    margin: 0;
                    line-height: 1.8;
                    font-size: 14px;
                }
                
                /* Print specific styles */
                @media print {
                    * {
                        -webkit-print-color-adjust: exact !important;
                        color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    body {
                        padding: 0;
                        margin: 0;
                        -webkit-print-color-adjust: exact;
                        color-adjust: exact;
                        print-color-adjust: exact;
                    }
                    
                    .invoice-preview {
                        box-shadow: none;
                        padding: 20px;
                        margin: 0;
                        max-width: none;
                        border: none;
                    }
                    
                    .page-break-before {
                        page-break-before: always;
                    }
                    
                    .page-break-after {
                        page-break-after: always;
                    }
                    
                    .signature-section,
                    .bank-details-section,
                    .totals-section {
                        page-break-inside: avoid;
                    }
                    
                    .items-table th {
                        background: var(--primary-color) !important;
                        color: white !important;
                    }
                    
                    .bank-details-section > div > div {
                        background-color: var(--text-color) !important;
                        color: white !important;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 6px 20px rgba(0,0,0,0.19) !important;
                    }
                    
                    .total-final {
                        color: var(--primary-color) !important;
                        border-top: 2px solid var(--primary-color) !important;
                    }
                    
                    .invoice-title {
                        color: var(--primary-color) !important;
                    }
                    
                    .bank-details-section h3 {
                        color: var(--primary-color) !important;
                    }
                    
                    .client-info h4 {
                        color: var(--primary-color) !important;
                    }
                }
            </style>
        </head>
        <body>
            ${invoiceContent.outerHTML}
        </body>
        </html>
    `);

        printWindow.document.close();

            // Wait for content to load then print
            printWindow.onload = function () {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                    console.log('✅ Print dialog opened successfully');
                }, 200); // Reduced delay for faster response
            };
            
            // Fallback if onload doesn't fire
            setTimeout(() => {
                if (printWindow && !printWindow.closed) {
                    printWindow.print();
                    console.log('🔄 Fallback print executed');
                }
            }, 1000);
            
        } catch (error) {
            console.error('❌ Error during download/print:', error);
            alert('There was an error preparing the invoice for download. Please try again.');
        } finally {
            // Restore button state
            if (downloadBtn) {
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        }
    }

    // Save invoice
    function saveInvoice() {
        // Debug: Check if form has data before submitting
        const form = document.getElementById('invoice-form');
        const formData = new FormData(form);

        // Validate form data before submission

        // Check if we have any items
        let hasItems = false;
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('items[') && key.includes('[quantity]') && value.trim() !== '') {
                hasItems = true;
                break;
            }
            if (key.startsWith('items[') && key.includes('[unit_price]') && value.trim() !== '') {
                hasItems = true;
                break;
            }
        }

        if (!hasItems) {
            alert('Please add at least one item with quantity or price before saving.');
            return;
        }

        // Validate required fields
        const clientName = document.getElementById('client_name').value.trim();
        if (!clientName) {
            alert('Please enter a client name.');
            document.getElementById('client_name').focus();
            return;
        }

        form.submit();
    }

    // Generate auto invoice number
    function generateInvoiceNumber() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const hours = String(today.getHours()).padStart(2, '0');
        const minutes = String(today.getMinutes()).padStart(2, '0');
        const seconds = String(today.getSeconds()).padStart(2, '0');
        
        // Add random component to avoid collisions
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');

        return `INV-${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
    }

    // Update invoice number in preview
    function updateInvoiceNumber() {
        const invoiceNumberInput = document.getElementById('invoice_number');
        const previewInvoiceNumber = document.getElementById('preview-invoice-number');

        let invoiceNumber = invoiceNumberInput.value.trim();

        // If field is empty, generate auto number
        if (!invoiceNumber) {
            invoiceNumber = generateInvoiceNumber();
            invoiceNumberInput.value = invoiceNumber;
        }

        previewInvoiceNumber.textContent = invoiceNumber;
    }

    // Regenerate invoice number manually
    function regenerateInvoiceNumber() {
        const invoiceNumberInput = document.getElementById('invoice_number');
        const newInvoiceNumber = generateInvoiceNumber();
        invoiceNumberInput.value = newInvoiceNumber;
        updateInvoiceNumber();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        // Set today's date
        document.getElementById('preview-date').textContent = new Date().toLocaleDateString();

        // Generate initial invoice number
        updateInvoiceNumber();

        // Add event listener for invoice number changes
        document.getElementById('invoice_number').addEventListener('input', function () {
            updateInvoiceNumber();
        });

        // Company details toggle functionality
        const showCompanyToggle = document.getElementById('show-company-details');
        showCompanyToggle.addEventListener('change', function () {
            updateCompanyDetailsDisplay();
        });

        // Bank details toggle functionality
        const showBankToggle = document.getElementById('show-bank-details');
        showBankToggle.addEventListener('change', function () {
            updateBankDetailsDisplay();
        });

        // Initial updates
        updateCompanyDetailsDisplay();
        updateBankDetailsDisplay();
        
        // Force initial bank details display if toggle is checked
        const bankToggle = document.getElementById('show-bank-details');
        if (bankToggle && bankToggle.checked) {
            updateBankDetailsDisplay();
        }

        // Add download button event listener with debounce
        const downloadBtn = document.getElementById('download-invoice-btn');
        if (downloadBtn) {
            let isProcessing = false;
            downloadBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                if (isProcessing) return; // Prevent multiple clicks
                
                isProcessing = true;
                try {
                    await downloadInvoice();
                } finally {
                    setTimeout(() => {
                        isProcessing = false;
                    }, 2000); // Prevent rapid clicking for 2 seconds
                }
            });
        }

        // Add event listeners to all form inputs
        document.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('input', updatePreview);
        });

        // Add specific listeners for calculation fields to ensure immediate recalculation
        const calculationFields = ['tax_rate', 'discount', 'shipping_fee', 'other_charges', 'amount_paid'];
        calculationFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function () {
                    calculateTotals();
                });
                field.addEventListener('blur', function () {
                    calculateTotals();
                });
            }
        });

        // Initialize first item
        addItemEventListeners(1);

        // Add currency dropdown change listener
        const currencyDropdown = document.getElementById('currency_code');
        if (currencyDropdown) {
            currencyDropdown.addEventListener('change', handleCurrencyChange);

            // Set initial currency based on current symbol
            const currentSymbol = '{{ currency_symbol|default:"₦" }}';
            for (let option of currencyDropdown.options) {
                if (option.getAttribute('data-symbol') === currentSymbol) {
                    option.selected = true;
                    break;
                }
            }
        }



        // Initial preview update
        updatePreview();

        // Fix mouse wheel scrolling for form and preview sections
        function enableMouseWheelScrolling() {
            const formSection = document.querySelector('.form-section');
            const previewSection = document.querySelector('.preview-section');
            
            // Enable mouse wheel scrolling for form section
            if (formSection) {
                formSection.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    this.scrollTop += e.deltaY;
                }, { passive: false });
                
                // Ensure the section can receive focus for scrolling
                formSection.tabIndex = -1;
            }
            
            // Enable mouse wheel scrolling for preview section
            if (previewSection) {
                previewSection.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    this.scrollTop += e.deltaY;
                }, { passive: false });
                
                // Ensure the section can receive focus for scrolling
                previewSection.tabIndex = -1;
            }
            
            console.log('✅ Mouse wheel scrolling enabled for form and preview sections');
        }
        
        // Initialize mouse wheel scrolling
        enableMouseWheelScrolling();
        
        // Quick element caching - immediate
        window.formElements = {
            clientName: document.getElementById('client_name'),
            clientEmail: document.getElementById('client_email'),
            clientPhone: document.getElementById('client_phone'),
            clientAddress: document.getElementById('client_address'),
            dueDate: document.getElementById('due_date'),
            currencyCode: document.getElementById('currency_code'),
            currencySymbol: document.getElementById('currency_symbol'),
            taxRate: document.getElementById('tax_rate'),
            discount: document.getElementById('discount'),
            shippingFee: document.getElementById('shipping_fee'),
            otherCharges: document.getElementById('other_charges')
        };
        
        // Template color change functionality
        const templateSelect = document.getElementById('template');
        if (templateSelect) {
            // Function to update template colors - make it globally accessible
            window.updateTemplateColors = function() {
                const templateSelect = document.getElementById('template');
                if (!templateSelect) return;
                
                const selectedOption = templateSelect.selectedOptions[0];
                if (selectedOption && selectedOption.dataset.primary) {
                    // Update CSS variables
                    document.documentElement.style.setProperty('--primary-color', selectedOption.dataset.primary);
                    document.documentElement.style.setProperty('--secondary-color', selectedOption.dataset.secondary);
                    document.documentElement.style.setProperty('--text-color', selectedOption.dataset.text);
                    document.documentElement.style.setProperty('--accent-color', selectedOption.dataset.accent);
                    
                    console.log('🎨 Template colors updated:', {
                        primary: selectedOption.dataset.primary,
                        secondary: selectedOption.dataset.secondary,
                        text: selectedOption.dataset.text,
                        accent: selectedOption.dataset.accent
                    });
                } else {
                    console.log('⚠️ No template selected or no color data available');
                }
            }
            
            // Update colors when template selection changes
            templateSelect.addEventListener('change', window.updateTemplateColors);
            
            // Update colors on page load if default template is selected
            if (templateSelect.selectedOptions.length > 0) {
                window.updateTemplateColors();
            }
        }
    });
    
    // Auto-refresh templates when window gains focus (returning from template management)
    let pageHidden = false;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            pageHidden = true;
        } else if (pageHidden) {
            // Page became visible again, refresh templates
            pageHidden = false;
            setTimeout(window.refreshTemplates, 500); // Small delay to ensure page is fully loaded
        }
    });
    
    // Function to refresh template options
    window.refreshTemplates = function() {
        console.log('🔄 Refreshing templates...');
        
        fetch('/invoices/api/templates/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
            .then(response => {
                console.log('API Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API Response data:', data);
                const templateSelect = document.getElementById('template');
                if (templateSelect && data.templates) {
                    const currentValue = templateSelect.value;
                    console.log('Current template value:', currentValue);
                    
                    // Clear existing options except first
                    templateSelect.innerHTML = '<option value="">Choose a template (optional)</option>';
                    
                    // Add updated templates
                    data.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.dataset.primary = template.primary_color;
                        option.dataset.secondary = template.secondary_color;
                        option.dataset.text = template.text_color;
                        option.dataset.accent = template.accent_color;
                        option.textContent = template.name + (template.is_default ? ' (Default)' : '');
                        if (template.is_default) {
                            option.selected = true;
                        }
                        templateSelect.appendChild(option);
                        console.log('Added template:', template.name, 'Colors:', template.primary_color);
                    });
                    
                    // Restore previous selection if it still exists
                    if (currentValue) {
                        templateSelect.value = currentValue;
                    }
                    
                    // Update colors for current selection
                    window.updateTemplateColors();
                    
                    console.log('✅ Templates refreshed successfully');
                    alert('Templates refreshed!');
                } else {
                    console.warn('No template select element or template data found');
                }
            })
            .catch(error => {
                console.error('❌ Error refreshing templates:', error);
                alert('Failed to refresh templates: ' + error.message + '. Please reload the page.');
            });
    };
    
    // Debug function to test API
    window.testAPI = function() {
        console.log('🧪 Testing API endpoint...');
        fetch('/invoices/api/templates/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('Test API Response status:', response.status);
            return response.text();
        })
        .then(data => {
            console.log('Test API Response data:', data);
            try {
                const json = JSON.parse(data);
                console.log('Parsed JSON:', json);
            } catch (e) {
                console.log('Not JSON, raw response:', data);
            }
        })
        .catch(error => {
            console.error('Test API Error:', error);
        });
    };
    
    // Debug function to test color updates
    window.testColors = function() {
        console.log('🎨 Testing color updates...');
        document.documentElement.style.setProperty('--primary-color', '#00ff00');
        console.log('Primary color set to green');
    };
</script>

<!-- Add html2pdf library for PDF download functionality - Lazy loaded -->
<script>
// Lazy load html2pdf only when needed
window.loadHtml2Pdf = function() {
    if (!window.html2pdf) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        script.async = true;
        document.head.appendChild(script);
        return new Promise(resolve => {
            script.onload = () => resolve();
        });
    }
    return Promise.resolve();
};
</script>
{% endblock %}