{% extends 'base.html' %}
{% load static %}

{% block title %}Template: {{ template.name }} - Multi-Purpose Business App{% endblock %}
{% block page_title %}Template: {{ template.name }}{% endblock %}
{% block breadcrumb %}Template Details{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card my-4">
      <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
        <div class="shadow-primary border-radius-lg pt-4 pb-3" style="background: linear-gradient(45deg, {{ template.primary_color }}, {{ template.primary_color }}dd);">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="text-white text-capitalize ps-3">{{ template.name }}</h6>
            <div class="pe-3">
              <a href="{% url 'waybills:create_original' %}?template_id={{ template.id }}" class="btn btn-outline-white btn-sm mb-0 me-2">
                <i class="material-icons text-sm">add</i> Use Template
              </a>
              <a href="{% url 'waybills:template_edit' template.pk %}" class="btn btn-outline-white btn-sm mb-0 me-2">
                <i class="material-icons text-sm">edit</i> Edit
              </a>
              <a href="{% url 'waybills:template_list' %}" class="btn btn-outline-white btn-sm mb-0">
                <i class="material-icons text-sm">arrow_back</i> Back
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card-body">
        <div class="row">
          <!-- Template Information -->
          <div class="col-md-8">
            <!-- Basic Info -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0">Template Information</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Name:</strong> {{ template.name }}</p>
                    <p><strong>Document Title:</strong> {{ template.document_title }}</p>
                    <p><strong>Number Prefix:</strong> {{ template.number_prefix }}</p>
                    <p><strong>Created:</strong> {{ template.created_at|date:"M d, Y g:i A" }}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Last Updated:</strong> {{ template.updated_at|date:"M d, Y g:i A" }}</p>
                    <p><strong>Status:</strong> 
                      {% if template.is_default %}
                        <span class="badge bg-success">Default Template</span>
                      {% else %}
                        <span class="badge bg-secondary">Custom Template</span>
                      {% endif %}
                    </p>
                  </div>
                </div>
                
                {% if template.description %}
                <div class="mt-3">
                  <strong>Description:</strong>
                  <p class="text-muted">{{ template.description }}</p>
                </div>
                {% endif %}
              </div>
            </div>
            
            <!-- Custom Fields Configuration -->
            <div class="card mb-4">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Custom Fields</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="editCustomFields()">
                  <i class="material-icons text-sm">edit</i> Edit Fields
                </button>
              </div>
              <div class="card-body">
                {% if template.custom_fields %}
                  {% for section_key, section_config in template.custom_fields.items %}
                    <div class="mb-3">
                      <h6 style="color: {{ template.primary_color }};">{{ section_config.label }}</h6>
                      {% if section_config.fields %}
                        <div class="row">
                          {% for field_key, field_config in section_config.fields.items %}
                            <div class="col-md-6 mb-2">
                              <div class="p-2 border rounded" style="background-color: {{ template.secondary_color }};">
                                <strong>{{ field_config.label }}</strong>
                                <br><small class="text-muted">
                                  Type: {{ field_config.type|title }}
                                  {% if field_config.required %} â€¢ Required{% endif %}
                                </small>
                                {% if field_config.placeholder %}
                                  <br><small class="text-muted">Placeholder: "{{ field_config.placeholder }}"</small>
                                {% endif %}
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="text-muted">No custom fields configured. Default fields will be used.</p>
                {% endif %}
              </div>
            </div>
            
            <!-- Table Columns Configuration -->
            <div class="card mb-4">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Table Columns</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="editTableColumns()">
                  <i class="material-icons text-sm">edit</i> Edit Columns
                </button>
              </div>
              <div class="card-body">
                {% if template.table_columns %}
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead style="background-color: {{ template.primary_color }}; color: white;">
                        <tr>
                          <th>S/N</th>
                          {% for column in template.table_columns %}
                            <th style="width: {{ column.width|default:'auto' }};">{{ column.label|upper }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        <tr style="background-color: {{ template.secondary_color }};">
                          <td>1</td>
                          {% for column in template.table_columns %}
                            <td>
                              <small class="text-muted">
                                {{ column.name }} ({{ column.type|default:'text' }})
                              </small>
                            </td>
                          {% endfor %}
                        </tr>
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <p class="text-muted">No custom columns configured. Default columns will be used.</p>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Template Preview -->
          <div class="col-md-4">
            <div class="card sticky-top">
              <div class="card-header">
                <h6 class="mb-0">Preview</h6>
              </div>
              <div class="card-body">
                <div class="template-preview" style="border: 2px solid {{ template.primary_color }}; border-radius: 8px; padding: 20px; background: white; font-size: 12px;">
                  <!-- Header -->
                  {% if template.show_company_logo or template.show_company_details %}
                  <div class="d-flex justify-content-between align-items-center mb-3 pb-2" style="border-bottom: 1px solid #ddd;">
                    {% if template.show_company_logo %}
                    <div style="width: 60px; height: 40px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                      <small>LOGO</small>
                    </div>
                    {% endif %}
                    {% if template.show_company_details %}
                    <div class="text-end">
                      <div style="font-weight: bold;">Company Name</div>
                      <small>Company Details</small>
                    </div>
                    {% endif %}
                  </div>
                  {% endif %}
                  
                  <!-- Title -->
                  <div class="text-center mb-3" style="color: {{ template.primary_color }}; font-weight: bold; font-size: 16px;">
                    {{ template.document_title }}
                  </div>
                  
                  <!-- Info Bar -->
                  <div class="mb-3 p-2" style="background: {{ template.primary_color }}; color: white; border-radius: 4px; font-size: 10px;">
                    <div class="d-flex justify-content-between">
                      <span>{{ template.number_prefix }}-2025-####</span>
                      <span>Date</span>
                      <span>Status</span>
                    </div>
                  </div>
                  
                  <!-- Custom Sections -->
                  {% if template.custom_fields %}
                    {% for section_key, section_config in template.custom_fields.items %}
                      <div class="mb-2">
                        <div style="color: {{ template.primary_color }}; font-weight: bold; font-size: 11px; border-bottom: 1px solid #eee; padding-bottom: 2px;">
                          {{ section_config.label|upper }}
                        </div>
                        <div class="p-2" style="background: {{ template.secondary_color }}; border-radius: 3px; margin-top: 2px;">
                          <small style="color: {{ template.text_color }};">
                            {% for field_key, field_config in section_config.fields.items %}
                              {{ field_config.label }}: Sample Data<br>
                            {% endfor %}
                          </small>
                        </div>
                      </div>
                    {% endfor %}
                  {% endif %}
                  
                  <!-- Items Table -->
                  <div class="mb-3">
                    <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
                      <thead>
                        <tr style="background: {{ template.primary_color }}; color: white;">
                          <th style="border: 1px solid #ddd; padding: 3px; text-align: center;">S/N</th>
                          {% if template.table_columns %}
                            {% for column in template.table_columns %}
                              <th style="border: 1px solid #ddd; padding: 3px;">{{ column.label|truncatechars:8 }}</th>
                            {% endfor %}
                          {% else %}
                            <th style="border: 1px solid #ddd; padding: 3px;">DESCRIPTION</th>
                            <th style="border: 1px solid #ddd; padding: 3px;">QTY</th>
                          {% endif %}
                        </tr>
                      </thead>
                      <tbody>
                        <tr style="background: {{ template.secondary_color }};">
                          <td style="border: 1px solid #ddd; padding: 3px; text-align: center;">1</td>
                          {% if template.table_columns %}
                            {% for column in template.table_columns %}
                              <td style="border: 1px solid #ddd; padding: 3px;">Sample</td>
                            {% endfor %}
                          {% else %}
                            <td style="border: 1px solid #ddd; padding: 3px;">Sample Item</td>
                            <td style="border: 1px solid #ddd; padding: 3px;">1</td>
                          {% endif %}
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <!-- Footer Elements -->
                  {% if template.show_signature %}
                  <div class="text-center mb-2">
                    <div style="border-top: 1px solid #333; width: 100px; margin: 10px auto;"></div>
                    <small>Signature</small>
                  </div>
                  {% endif %}
                  
                  {% if template.show_bank_details %}
                  <div class="p-2" style="background: {{ template.secondary_color }}; border-radius: 3px;">
                    <div style="color: {{ template.primary_color }}; font-weight: bold; font-size: 10px;">BANK DETAILS</div>
                    <small style="color: {{ template.text_color }};">Bank information will appear here</small>
                  </div>
                  {% endif %}
                </div>
                
                <!-- Display Options -->
                <div class="mt-3">
                  <h6>Display Options</h6>
                  <div class="row text-center">
                    <div class="col-6 mb-2">
                      <i class="material-icons text-sm {% if template.show_company_logo %}text-success{% else %}text-muted{% endif %}">business</i>
                      <br><small>Logo</small>
                    </div>
                    <div class="col-6 mb-2">
                      <i class="material-icons text-sm {% if template.show_company_details %}text-success{% else %}text-muted{% endif %}">info</i>
                      <br><small>Details</small>
                    </div>
                    <div class="col-6 mb-2">
                      <i class="material-icons text-sm {% if template.show_bank_details %}text-success{% else %}text-muted{% endif %}">account_balance</i>
                      <br><small>Bank</small>
                    </div>
                    <div class="col-6 mb-2">
                      <i class="material-icons text-sm {% if template.show_signature %}text-success{% else %}text-muted{% endif %}">edit</i>
                      <br><small>Signature</small>
                    </div>
                  </div>
                </div>
                
                <!-- Color Palette -->
                <div class="mt-3">
                  <h6>Color Palette</h6>
                  <div class="d-flex gap-2">
                    <div class="flex-fill text-center">
                      <div style="background: {{ template.primary_color }}; height: 30px; border-radius: 4px; border: 1px solid #ddd;"></div>
                      <small class="text-muted">Primary</small>
                    </div>
                    <div class="flex-fill text-center">
                      <div style="background: {{ template.secondary_color }}; height: 30px; border-radius: 4px; border: 1px solid #ddd;"></div>
                      <small class="text-muted">Secondary</small>
                    </div>
                    <div class="flex-fill text-center">
                      <div style="background: {{ template.text_color }}; height: 30px; border-radius: 4px; border: 1px solid #ddd;"></div>
                      <small class="text-muted">Text</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="text-center mt-4">
          <a href="{% url 'waybills:create_original' %}?template_id={{ template.id }}" class="btn btn-primary me-2">
            <i class="material-icons text-sm">add</i> Create Waybill with Template
          </a>
          <a href="{% url 'waybills:template_duplicate' template.pk %}" class="btn btn-outline-primary me-2">
            <i class="material-icons text-sm">content_copy</i> Duplicate Template
          </a>
          <a href="{% url 'waybills:template_edit' template.pk %}" class="btn btn-outline-secondary">
            <i class="material-icons text-sm">edit</i> Edit Template
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.template-preview {
  max-height: 600px;
  overflow-y: auto;
}

.sticky-top {
  top: 20px;
}

.card {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: none;
}

.d-flex.gap-2 {
  gap: 0.5rem !important;
}

.flex-fill {
  flex: 1 1 0%;
}

.template-preview table {
  font-size: 9px !important;
}

.template-preview th,
.template-preview td {
  padding: 3px !important;
  font-size: 9px !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function editCustomFields() {
    // This would open a modal or redirect to field editor
    alert('Custom field editor will be implemented in the next phase. For now, you can edit the template and manually configure the custom_fields JSON.');
}

function editTableColumns() {
    // This would open a modal or redirect to column editor  
    alert('Table column editor will be implemented in the next phase. For now, you can edit the template and manually configure the table_columns JSON.');
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Alt + U: Use template
    if (e.altKey && e.key === 'u') {
        e.preventDefault();
        window.location.href = '{% url "waybills:create_original" %}?template_id={{ template.id }}';
    }
    
    // Alt + E: Edit template
    if (e.altKey && e.key === 'e') {
        e.preventDefault();
        window.location.href = '{% url "waybills:template_edit" template.pk %}';
    }
    
    // Alt + D: Duplicate template
    if (e.altKey && e.key === 'd') {
        e.preventDefault();
        window.location.href = '{% url "waybills:template_duplicate" template.pk %}';
    }
});
</script>
{% endblock %}
